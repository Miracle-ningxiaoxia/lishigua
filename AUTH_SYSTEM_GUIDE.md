# æ‹¾å…‰çºª Â· ä¸“å±èº«ä»½éªŒè¯ç³»ç»Ÿå®ç°æ–‡æ¡£

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

å·²æˆåŠŸå®ç°åŸºäº **Auth.js (NextAuth.js) v5** çš„é‚€è¯·ç è®¤è¯ç³»ç»Ÿï¼Œé‡‡ç”¨æ˜Ÿç©ºæç®€è®¾è®¡é£æ ¼ã€‚

---

## ğŸ—ï¸ æ¶æ„ç»„æˆ

### 1. æ ¸å¿ƒé…ç½®æ–‡ä»¶

#### `src/auth.ts`
- NextAuth.js æ ¸å¿ƒé…ç½®
- ä½¿ç”¨ CredentialsProvider å®ç°é‚€è¯·ç ç™»å½•
- JWT ä¼šè¯ç­–ç•¥ï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰
- è‡ªå®šä¹‰ callbacks å¤„ç†ç”¨æˆ·ä¿¡æ¯

#### `src/lib/supabase.ts`
- Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–
- `verifyInviteCode()` å‡½æ•°ï¼šæŸ¥è¯¢ members è¡¨éªŒè¯é‚€è¯·ç 
- Member ç±»å‹å®šä¹‰

#### `src/lib/auth-helpers.ts`
- æœåŠ¡ç«¯è¾…åŠ©å‡½æ•°
- `getServerSession()`: è·å–å½“å‰ä¼šè¯
- `getCurrentUser()`: è·å–å½“å‰ç”¨æˆ·
- `isAuthenticated()`: æ£€æŸ¥ç™»å½•çŠ¶æ€

---

### 2. API è·¯ç”±

#### `src/app/api/auth/[...nextauth]/route.ts`
- NextAuth.js API å¤„ç†å™¨
- å¤„ç†æ‰€æœ‰è®¤è¯ç›¸å…³è¯·æ±‚ï¼ˆç™»å½•ã€ç™»å‡ºã€ä¼šè¯æ£€æŸ¥ç­‰ï¼‰

---

### 3. ä¸­é—´ä»¶ï¼ˆè·¯ç”±ä¿æŠ¤ï¼‰

#### `src/middleware.ts`
- å…¨å±€è·¯ç”±å®ˆå«
- æœªç™»å½•ç”¨æˆ·è®¿é—®å—ä¿æŠ¤è·¯ç”± â†’ é‡å®šå‘åˆ° `/login`
- å·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•é¡µ â†’ é‡å®šå‘åˆ°é¦–é¡µ
- æ’é™¤é™æ€èµ„æºå’Œ API è·¯ç”±

---

### 4. ç™»å½•é¡µé¢

#### `src/app/login/page.tsx`
**è®¾è®¡ç‰¹ç‚¹ï¼š**
- âœ¨ ä¸‰å±‚æ˜Ÿç©ºèƒŒæ™¯åŠ¨ç”»
- ğŸ’« æ¸å˜å…‰æ™•å‘¼å¸æ•ˆæœ
- ğŸ¯ èšç„¦æ—¶è¾“å…¥æ¡†å…‰æ•ˆ
- ğŸ¨ Framer Motion åŠ¨ç”»è¿‡æ¸¡
- ğŸ­ é”™è¯¯æç¤ºä¼˜é›…æ˜¾ç¤º
- âš¡ ç™»å½•æˆåŠŸåå»¶è¿Ÿè·³è½¬å¢åŠ ä»ªå¼æ„Ÿ

**äº¤äº’æµç¨‹ï¼š**
1. ç”¨æˆ·è¾“å…¥é‚€è¯·ç 
2. å‰ç«¯è°ƒç”¨ `signIn('credentials', { inviteCode })`
3. NextAuth è§¦å‘ `authorize` å›è°ƒ
4. åç«¯æŸ¥è¯¢ Supabase éªŒè¯é‚€è¯·ç 
5. éªŒè¯æˆåŠŸ â†’ åˆ›å»º Sessionï¼Œé‡å®šå‘åˆ°é¦–é¡µ
6. éªŒè¯å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯æç¤º

---

### 5. Providers

#### `src/components/providers/AuthProvider.tsx`
- åŒ…è£¹ `SessionProvider`
- ä½¿å®¢æˆ·ç«¯ç»„ä»¶å¯ä»¥ä½¿ç”¨ `useSession` Hook

#### å·²é›†æˆåˆ° `src/app/layout.tsx`
- å…¨å±€æä¾›è®¤è¯ä¸Šä¸‹æ–‡
- æ‰€æœ‰é¡µé¢å’Œç»„ä»¶éƒ½å¯è®¿é—®ä¼šè¯ä¿¡æ¯

---

### 6. å¯¼èˆªæ æ›´æ–°

#### `src/components/ui/Navigation.tsx`
**æ–°å¢åŠŸèƒ½ï¼š**
- å³ä¸Šè§’æ˜¾ç¤ºå½“å‰ç”¨æˆ·å
- ç™»å‡ºæŒ‰é’®ï¼ˆå¸¦æ‚¬åœæ•ˆæœï¼‰
- ç™»å½•/ç™»å‡ºé¡µé¢ä¸æ˜¾ç¤ºå¯¼èˆªæ 

---

### 7. ç±»å‹å®šä¹‰

#### `src/types/next-auth.d.ts`
- æ‰©å±• NextAuth ç±»å‹
- Session åŒ…å«ï¼š`id`, `name`, `coupleId`
- User å’Œ JWT ç±»å‹å¢å¼º

---

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

### `.env.local`
```env
# Supabase é…ç½®
NEXT_PUBLIC_SUPABASE_URL=https://yakoqbzwjxbpyedxmtnp.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_MHyTI7X2Kc6MTooi83eKqA_O_0x1-D2

# NextAuth é…ç½®
NEXTAUTH_SECRET=lishigua2026
NEXTAUTH_URL=http://localhost:3000
```

---

## ğŸ“Š æ•°æ®åº“ç»“æ„è¦æ±‚

### `members` è¡¨ï¼ˆSupabaseï¼‰
å¿…éœ€å­—æ®µï¼š
- `id` (uuid/text): ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- `name` (text): ç”¨æˆ·å§“å
- `invite_code` (text): é‚€è¯·ç ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰
- `couple_id` (integer, nullable): é…å¯¹ ID
- `created_at` (timestamp): åˆ›å»ºæ—¶é—´

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­è·å–ç”¨æˆ·ä¿¡æ¯

```typescript
import { getCurrentUser } from '@/lib/auth-helpers';

export default async function Page() {
  const user = await getCurrentUser();
  
  if (!user) {
    // ç”¨æˆ·æœªç™»å½•ï¼ˆä¸­é—´ä»¶åº”è¯¥å·²å¤„ç†é‡å®šå‘ï¼‰
    return null;
  }

  return (
    <div>
      <h1>æ¬¢è¿, {user.name}!</h1>
      <p>ä½ çš„ Couple ID: {user.coupleId}</p>
    </div>
  );
}
```

### åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨ä¼šè¯

```typescript
'use client';

import { useSession, signOut } from 'next-auth/react';

export default function ClientComponent() {
  const { data: session, status } = useSession();

  if (status === 'loading') {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (!session) {
    return <div>æœªç™»å½•</div>;
  }

  return (
    <div>
      <p>ä½ å¥½, {session.user.name}!</p>
      <button onClick={() => signOut()}>ç™»å‡º</button>
    </div>
  );
}
```

### æ‰‹åŠ¨ç™»å½•/ç™»å‡º

```typescript
import { signIn, signOut } from 'next-auth/react';

// ç™»å½•
await signIn('credentials', {
  inviteCode: 'YOUR_CODE',
  callbackUrl: '/',
});

// ç™»å‡º
await signOut({ callbackUrl: '/login' });
```

---

## ğŸ¨ UI è®¾è®¡äº®ç‚¹

### æ˜Ÿç©ºèƒŒæ™¯
- ä¸‰å±‚æ˜Ÿç©ºä»¥ä¸åŒé€Ÿåº¦é—ªçƒ
- CSS åŠ¨ç”»å®ç°ï¼Œæ€§èƒ½ä¼˜å¼‚
- è‡ªé€‚åº”å“åº”å¼è®¾è®¡

### å…‰æ™•æ•ˆæœ
- å¾„å‘æ¸å˜ + æ¨¡ç³Šæ»¤é•œ
- å‘¼å¸åŠ¨ç”»ï¼ˆscale + opacityï¼‰
- è¥é€ ç©ºçµæ°›å›´

### è¾“å…¥æ¡†äº¤äº’
- èšç„¦æ—¶è§¦å‘å…‰æ™•è¾¹æ¡†
- å¹³æ»‘çš„ scale åŠ¨ç”»
- å±…ä¸­çš„å¤§å·å­—æ¯é—´è·
- è‡ªå®šä¹‰å ä½ç¬¦æ ·å¼

### åŠ è½½çŠ¶æ€
- æ—‹è½¬åŠ è½½åŠ¨ç”»
- ç¦ç”¨çŠ¶æ€é€æ˜åº¦å˜åŒ–
- é˜²æ­¢é‡å¤æäº¤

---

## ğŸ”’ å®‰å…¨æ€§è¯´æ˜

### å½“å‰å®ç°
- âœ… çº¯é‚€è¯·ç éªŒè¯ï¼ˆæ— å¯†ç ï¼‰
- âœ… JWT Token å­˜å‚¨ï¼ˆhttpOnly Cookieï¼‰
- âœ… ä¸­é—´ä»¶ä¿æŠ¤æ‰€æœ‰è·¯ç”±
- âœ… ä¼šè¯è¿‡æœŸæ—¶é—´ï¼š30 å¤©

### æœªæ¥å¯å¢å¼º
- ğŸ”¹ é‚€è¯·ç å“ˆå¸Œå­˜å‚¨ï¼ˆbcrypt/argon2ï¼‰
- ğŸ”¹ ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
- ğŸ”¹ IP ç™½åå•
- ğŸ”¹ åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰

---

## ğŸ“ æµ‹è¯•æ¸…å•

### åŠŸèƒ½æµ‹è¯•
- [ ] è¾“å…¥æ­£ç¡®é‚€è¯·ç  â†’ ç™»å½•æˆåŠŸ
- [ ] è¾“å…¥é”™è¯¯é‚€è¯·ç  â†’ æ˜¾ç¤ºé”™è¯¯æç¤º
- [ ] æœªç™»å½•è®¿é—®å—ä¿æŠ¤è·¯ç”± â†’ é‡å®šå‘åˆ°ç™»å½•é¡µ
- [ ] å·²ç™»å½•è®¿é—®ç™»å½•é¡µ â†’ é‡å®šå‘åˆ°é¦–é¡µ
- [ ] ç™»å‡ºåŠŸèƒ½ â†’ æ¸…é™¤ä¼šè¯ï¼Œè·³è½¬ç™»å½•é¡µ

### UI æµ‹è¯•
- [ ] æ˜Ÿç©ºåŠ¨ç”»æ­£å¸¸æ’­æ”¾
- [ ] è¾“å…¥æ¡†èšç„¦/å¤±ç„¦æ•ˆæœæµç•…
- [ ] åŠ è½½çŠ¶æ€åŠ¨ç”»æ˜¾ç¤º
- [ ] é”™è¯¯æç¤ºåŠ¨ç”»è‡ªç„¶
- [ ] å“åº”å¼å¸ƒå±€é€‚é…ç§»åŠ¨ç«¯

### æ€§èƒ½æµ‹è¯•
- [ ] é¦–å±åŠ è½½æ—¶é—´ < 2s
- [ ] ç™»å½•è¯·æ±‚å“åº” < 500ms
- [ ] åŠ¨ç”»å¸§ç‡ >= 60fps

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### 1. ç™»å½•å¤±è´¥ï¼ˆé‚€è¯·ç æ­£ç¡®ï¼‰
- æ£€æŸ¥ Supabase URL å’Œ ANON_KEY æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ members è¡¨ä¸­æœ‰è¯¥é‚€è¯·ç è®°å½•
- æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°å’ŒæœåŠ¡ç«¯æ—¥å¿—

### 2. ä¸­é—´ä»¶ä¸ç”Ÿæ•ˆ
- ç¡®è®¤ `middleware.ts` åœ¨ `src` ç›®å½•æ ¹çº§åˆ«
- æ£€æŸ¥ `next.config.ts` æ˜¯å¦æ­£ç¡®é…ç½®
- é‡å¯å¼€å‘æœåŠ¡å™¨

### 3. ä¼šè¯ä¿¡æ¯ä¸¢å¤±
- æ£€æŸ¥ `NEXTAUTH_SECRET` æ˜¯å¦è®¾ç½®
- ç¡®è®¤ Cookie æœªè¢«æµè§ˆå™¨é˜»æ­¢
- æ¸…é™¤æµè§ˆå™¨ Cookie åé‡è¯•

### 4. ç±»å‹é”™è¯¯
- è¿è¡Œ `npm run build` æ£€æŸ¥ç±»å‹é—®é¢˜
- ç¡®è®¤ `src/types/next-auth.d.ts` å·²æ­£ç¡®å£°æ˜

---

## ğŸ“¦ ä¾èµ–åŒ…

å·²å®‰è£…çš„å…³é”®ä¾èµ–ï¼š
```json
{
  "next-auth": "^5.0.0-beta.30",
  "@supabase/supabase-js": "^2.91.1",
  "framer-motion": "^12.26.2"
}
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. **æ•°æ®åº“å‡†å¤‡**
   - ç¡®ä¿ Supabase ä¸­ `members` è¡¨å·²åˆ›å»º
   - æ’å…¥ 14 ä½æˆå‘˜çš„é‚€è¯·ç æ•°æ®

2. **æœ¬åœ°æµ‹è¯•**
   ```bash
   npm run dev
   ```
   è®¿é—® `http://localhost:3000/login` æµ‹è¯•ç™»å½•

3. **æ ·å¼å¾®è°ƒ**
   - æ ¹æ®å“ç‰Œè‰²è°ƒæ•´æ¸å˜è‰²
   - ä¼˜åŒ–ç§»åŠ¨ç«¯é€‚é…

4. **ç”Ÿäº§éƒ¨ç½²**
   - æ›´æ–° `NEXTAUTH_URL` ä¸ºç”Ÿäº§åŸŸå
   - å¯ç”¨ HTTPS
   - é…ç½® Vercel ç¯å¢ƒå˜é‡

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Next.js å®˜æ–¹æ–‡æ¡£: https://nextjs.org/docs
2. NextAuth.js æ–‡æ¡£: https://authjs.dev
3. Supabase æ–‡æ¡£: https://supabase.com/docs

---

**ğŸ‰ è®¤è¯ç³»ç»Ÿå·²å®Œæˆï¼Œç¥ã€Œæ‹¾å…‰çºªã€é¡¹ç›®é¡ºåˆ©ï¼**
